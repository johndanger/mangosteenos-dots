# When dotfiles are merged to main, trigger a build of the bootc image so the
# image picks up the latest dotfiles.
#
# Required secrets (Settings → Secrets and variables → Actions):
#   BOOTC_IMAGE_REPO - Exact "owner/repo" from the bootc image repo URL (case-sensitive for orgs).
#                      Example: mangosteenOS/bootc_image (from https://github.com/mangosteenOS/bootc_image)
#   BOOTC_IMAGE_PAT  - PAT that can trigger workflows in that repo:
#                      • Classic PAT: "repo" scope; account must have access to the private repo.
#                      • Fine-grained PAT: only the bootc image repo, "Contents: read and write".
#                      If the repo is under an org with SSO, authorize the PAT for SSO.
---
name: Trigger bootc image build

on:
  push:
    branches:
      - main
      - master

jobs:
  trigger-build:
    name: Trigger bootc image build
    runs-on: ubuntu-latest
    steps:
      - name: Verify repo format
        run: |
          REPO="${{ secrets.BOOTC_IMAGE_REPO }}"
          if [[ ! "$REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "::error::BOOTC_IMAGE_REPO should be 'owner/repo' (e.g. mangosteenOS/bootc_image). Got: ${REPO:0:20}..."
            exit 1
          fi
          echo "Repository format OK (owner/repo)"

      - name: Repository dispatch
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.BOOTC_IMAGE_PAT }}
          repository: ${{ secrets.BOOTC_IMAGE_REPO }}
          event-type: dotfiles-updated
          client-payload: '{"dotfiles_ref": "${{ github.sha }}", "dotfiles_repo": "${{ github.repository }}"}'
